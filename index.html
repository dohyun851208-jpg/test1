<!DOCTYPE html>
<html>

<head>
    <base target="_top">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8">
    <title>AI 동료평가 도우미</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="card">
        <h1><span class="floating">🏫</span> AI 동료평가 도우미</h1>
        <div class="tab-container">
            <button class="tab-btn active" onclick="switchMainTab('student')">학생용 페이지</button>
            <button class="tab-btn" onclick="switchMainTab('teacher')">교사용 페이지</button>
        </div>
        <div id="studentTab">
            <div id="studentLoginSection">
                <div class="accent-box box-blue">
                    <span class="box-label">학생 로그인</span>
                    <div id="classCodeStep">
                        <label>클래스 코드</label>
                        <input type="text" id="classCodeInput" placeholder="선생님이 알려준 코드 입력 (예: 23423)" maxlength="5"
                            required>
                        <button type="button" onclick="confirmClassCode()"
                            style="background:var(--color-blue);">다음</button>
                    </div>
                    <div id="studentCredStep" class="hidden">
                        <div
                            style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                            <span style="font-weight:700; color:var(--color-blue);" id="classCodeDisplay"></span>
                            <button type="button" onclick="backToClassCode()"
                                style="width:auto; padding:6px 12px; font-size:0.8rem; background:#C8C1B8; color:var(--text-main); box-shadow:none;">코드
                                변경</button>
                        </div>
                        <div class="type-selector">
                            <label><input type="radio" name="loginType" value="individual" checked
                                    onchange="toggleLoginType()"> 👤 개인</label>
                            <label><input type="radio" name="loginType" value="group" onchange="toggleLoginType()"> 👥
                                모둠</label>
                        </div>
                        <label id="loginIdLabel">나의 번호</label>
                        <input type="number" id="loginId" placeholder="번호 입력 (예: 15)" required>
                        <label>비밀번호</label>
                        <input type="password" id="loginPw" placeholder="비밀번호 입력" required>
                        <button id="studentLoginBtn" onclick="loginStudent()">로그인</button>
                        <div id="loginMsg" class="message"></div>
                    </div>
                    <div id="loginMsg" class="message"></div>
                </div>
            </div>
            <div id="studentMainSection" class="hidden">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <span id="welcomeMsg" style="font-weight:700; color:var(--primary); font-size:1.1rem;"></span>
                    <button onclick="logoutStudent()"
                        style="width:auto; padding:8px 15px; font-size:0.85rem; background:#C8C1B8; color:var(--text-main); box-shadow:none;">로그아웃</button>
                </div>
                <div class="mini-tab-container">
                    <button class="mini-tab-btn active-student" onclick="switchStudentSubTab('submit')">📝 평가
                        하기</button>
                    <button class="mini-tab-btn" onclick="switchStudentSubTab('result')">📊 결과 보기</button>
                </div>
                <div id="studentSubmitTab">
                    <form id="reviewForm">
                        <label>평가 날짜</label>
                        <input type="date" id="reviewDate" required onchange="syncAllDates(this.value)">
                        <div class="type-selector">
                            <label><input type="radio" name="evalTypeDisplay" value="individual"
                                    onchange="switchTypeAndLogout('individual')"> 👤 개인평가</label>
                            <label><input type="radio" name="evalTypeDisplay" value="group"
                                    onchange="switchTypeAndLogout('group')"> 👥 모둠평가</label>
                        </div>
                        <div class="accent-box box-blue">
                            <span class="box-label">🎯 학습 목표 및 평가 과제</span>
                            <div id="objectiveArea" style="margin-bottom:15px;">
                                <div
                                    style="font-weight:700; color:var(--color-blue); font-size:0.85rem; margin-bottom:5px;">
                                    학습 목표</div>
                                <div id="objectiveText" style="color:var(--text-main);">등록된 학습목표가 없습니다.</div>
                            </div>
                            <div id="taskArea" style="border-top:1px dashed var(--border); padding-top:15px;">
                                <div
                                    style="font-weight:700; color:var(--color-blue); font-size:0.85rem; margin-bottom:5px;">
                                    평가 과제</div>
                                <div id="taskText" style="color:var(--text-main);">등록된 평가과제가 없습니다.</div>
                            </div>
                        </div>
                        <div class="accent-box box-teal">
                            <span class="box-label">📝 평가 정보 입력</span>
                            <label id="submitReviewerLabel">나의 번호</label>
                            <input type="text" id="reviewerId" readonly
                                style="background:var(--border-light); cursor:not-allowed;">
                            <label id="submitTargetLabel">평가 대상 선택</label>
                            <div id="progressArea" style="margin-bottom:15px;">
                                <div class="progress-text" id="progressText">평가 진행: 0 / 0명</div>
                                <div class="progress-bar-container">
                                    <div class="progress-bar-fill" id="progressBar" style="width:0%"></div>
                                </div>
                            </div>
                            <div id="targetGrid" class="target-grid"></div>
                            <input type="hidden" id="targetId">
                        </div>
                        <div id="ratingSection" class="accent-box box-amber hidden">
                            <span class="box-label">평가 기준</span>
                            <div id="ratingItems"></div>
                        </div>
                        <div class="accent-box box-green">
                            <span class="box-label">💬 서로의 발전을 돕는 피드백</span>
                            <textarea id="reviewContent"
                                placeholder="위의 평가 기준을 보며, 잘한 점과 특정 부분을 보완하면 더 발전할 수 있는 방법을 구체적으로 써 주세요." required
                                minlength="20" oninput="updateCharCount()" style="margin-bottom:5px;"></textarea>
                            <div id="charCount" style="text-align:right; font-size:0.85rem; color:var(--text-sub);">0자 /
                                최소 20자</div>
                        </div>
                        <button type="submit" id="submitBtn" class="not-ready">평가 제출하기</button>
                    </form>
                    <div id="submitMsg" class="message"></div>
                </div>
                <div id="studentResultTab" class="hidden">
                    <div class="type-selector" style="margin-bottom:20px;">
                        <label><input type="radio" name="resultEvalTypeDisplay" value="individual"
                                onchange="switchTypeAndLogout('individual')"> 👤 개인평가</label>
                        <label><input type="radio" name="resultEvalTypeDisplay" value="group"
                                onchange="switchTypeAndLogout('group')"> 👥 모둠평가</label>
                    </div>
                    <div class="accent-box box-amber">
                        <span class="box-label">결과 조회</span>
                        <label>조회 날짜</label>
                        <input type="date" id="viewDate" required onchange="syncAllDates(this.value)">
                        <button type="button" id="viewResultBtn" onclick="viewMyResult()">내 결과 확인하기</button>
                    </div>
                    <div id="viewMsg" class="message"></div>
                    <div id="resultArea" class="hidden" style="margin-top:30px;">
                        <div id="statsSummary" class="stats-summary"></div>
                        <div id="chartContainer" class="chart-container hidden">
                            <h4>📊 항목별 점수 현황</h4>
                            <div id="barChart" class="bar-chart"></div>
                        </div>
                        <div class="accent-box box-violet">
                            <span class="box-label" style="margin-bottom:8px;">🤖 AI 요약 리포트</span>
                            <div id="mySummary" style="color:var(--text-main);"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="teacherTab" class="hidden">
            <div id="teacherLogin">
                <div class="accent-box box-violet">
                    <span class="box-label">교사 전용</span>
                    <div id="teacherLoginMode">
                        <p style="text-align:center; color:var(--text-sub); margin-bottom:15px;">🔐 교사 전용 페이지입니다.</p>
                        <label>클래스 코드</label>
                        <input type="text" id="teacherClassCode" placeholder="클래스 코드 입력" maxlength="5" required>
                        <label>교사 비밀번호</label>
                        <input type="password" id="teacherPassword" placeholder="교사 비밀번호" required>
                        <button type="button" id="teacherLoginBtn" onclick="loginTeacher()">로그인</button>
                        <hr style="border:0; border-top:1px dashed var(--border); margin:20px 0;">
                        <button type="button" onclick="showRegisterMode()" style="background:var(--color-teal);">처음 사용자
                            — 새 클래스 만들기</button>
                    </div>
                    <div id="teacherRegisterMode" class="hidden">
                        <p style="text-align:center; color:var(--text-sub); margin-bottom:15px;">✨ 새 클래스를 만들어보세요!</p>
                        <label>클래스 코드 설정</label>
                        <input type="text" id="newClassCode" placeholder="예: 5반A, 301, math1" maxlength="5" required>
                        <p style="font-size:0.8rem; color:var(--text-sub); margin-top:-10px; margin-bottom:15px;">1~5자리,
                            숫자·영문·한글 조합 가능</p>
                        <label>교사 비밀번호 설정</label>
                        <input type="password" id="newTeacherPw2" placeholder="비밀번호 입력" required>
                        <button type="button" onclick="registerClass()" style="background:var(--color-teacher);">클래스
                            생성하기</button>
                        <button type="button" onclick="showLoginMode()"
                            style="background:#C8C1B8; color:var(--text-main); margin-top:10px;">← 로그인으로 돌아가기</button>
                    </div>
                </div>
                <div id="teacherLoginMsg" class="message"></div>
            </div>
            <div id="teacherMain" class="hidden">
                <div style="display:flex; justify-content:flex-end; gap:10px; margin-bottom:15px;">
                    <button id="classToggleBtn" onclick="toggleClassActive()"
                        style="width:auto; padding:8px 20px; background:#5E8C61; color:white; box-shadow:none; font-size:0.85rem;">🔓
                        활성화</button>
                    <button onclick="teacherLogout()"
                        style="width:auto; padding:8px 20px; background:#C8C1B8; color:var(--text-main); box-shadow:none; font-size:0.85rem;">로그아웃</button>
                </div>
                <div class="mini-tab-container">
                    <button class="mini-tab-btn active" onclick="switchMiniTab('ranking')">📊 전체 현황 보기</button>
                    <button class="mini-tab-btn" onclick="switchMiniTab('student')">👤 개별 피드백 확인하기</button>
                    <button class="mini-tab-btn" onclick="switchMiniTab('settings')">⚙️ 설정</button>
                </div>
                <div id="rankStudentArea" class="accent-box box-violet">
                    <div>
                        <div style="flex:1;"><label>조회 날짜</label><input type="date" id="teacherDate" required
                                onchange="syncAllDates(this.value); loadTeacherData()"></div>
                        <div class="type-selector">
                            <label><input type="radio" name="teacherEvalType" value="individual" checked
                                    onchange="loadTeacherData()"> 👤 개인</label>
                            <label><input type="radio" name="teacherEvalType" value="group"
                                    onchange="loadTeacherData()"> 👥 모둠</label>
                        </div>
                    </div>
                </div>
                <div id="rankingMiniTab">
                    <div id="teacherDashboard" class="stats-summary" style="margin-bottom:20px;"></div>
                    <h3>전체 현황 (내림차순)</h3>
                    <div style="overflow-x:auto;">
                        <div id="rankingTable"></div>
                    </div>
                </div>
                <div id="studentMiniTab" class="hidden">
                    <h3>대상 번호 선택</h3>
                    <div id="studentSelector" class="student-selector"></div>
                    <div id="studentReviews"></div>
                </div>
                <div id="settingsMiniTab" class="hidden">
                    <div class="accent-box box-teal">
                        <span class="box-label">📅 날짜별 기준 설정</span>
                        <div
                            style="background:rgba(255,255,255,0.5); padding:15px; border-radius:10px; border:1px solid var(--border);">
                            <label>설정할 날짜</label><input type="date" id="settingDate"
                                onchange="syncAllDates(this.value); loadCriteriaForEdit()">
                            <label>🎯 학습 목표</label><input type="text" id="settingObjective"
                                placeholder="예: 세계의 다양한 기후와 지형에 따른 사람들의 생활 모습을 조사할 수 있다.">
                            <label>📋 평가 과제</label><input type="text" id="settingTask"
                                placeholder="예: 자신이 선택한 나라의 생활 모습을 조사하여 여행 가이드북 만들어 발표하기">
                            <button type="button" onclick="saveBasicInfo(this)" class="save-basic-btn">💾 1단계: 학습목표 및
                                평가과제 저장하기</button>
                            <p style="font-size:0.8rem; color:var(--text-sub); margin-top:-15px; text-align:center;">⚠️
                                평가기준을 AI로 생성하려면 이 버튼을 먼저 눌러 저장해야 합니다.</p>
                        </div>
                        <hr style="border:0; border-top:2px dashed var(--border); margin:25px 0;">
                        <div
                            style="display:flex; justify-content:space-between; align-items:flex-end; margin-top:20px; margin-bottom:10px;">
                            <label style="margin:0; padding-bottom:5px;">📊 평가기준 설정 (2단계)</label>
                            <div class="mini-tab-container"
                                style="margin:0; padding:4px; width:260px; display:flex; gap:5px;">
                                <button type="button" class="mini-tab-btn active-setting"
                                    onclick="switchCriteriaMode('auto')" id="autoModeBtn"
                                    style="flex:1; font-size:0.85rem; padding:8px 0;">✨ AI로 생성하기</button>
                                <button type="button" class="mini-tab-btn" onclick="switchCriteriaMode('manual')"
                                    id="manualModeBtn" style="flex:1; font-size:0.85rem; padding:8px 0;">✏️ 수동
                                    작성하기</button>
                            </div>
                        </div>
                        <div id="autoCriteriaArea">
                            <div
                                style="background:var(--bg-soft); padding:15px; border-radius:10px; margin-bottom:15px; border:1px solid var(--border);">
                                <div style="display:flex; gap:10px; margin-bottom:10px;">
                                    <div style="flex:1;"><label style="font-size:0.8rem;">학교급</label><select
                                            id="autoSchoolLevel" style="margin-bottom:0;"
                                            onchange="updateGradeOptions()">
                                            <option value="초등학교" selected>초등학교</option>
                                            <option value="중학교">중학교</option>
                                            <option value="고등학교">고등학교</option>
                                        </select></div>
                                    <div style="flex:1;"><label style="font-size:0.8rem;">학년</label><select
                                            id="autoGradeSelect" style="margin-bottom:0;">
                                            <option value="1학년">1학년</option>
                                            <option value="2학년">2학년</option>
                                            <option value="3학년">3학년</option>
                                            <option value="4학년">4학년</option>
                                            <option value="5학년" selected>5학년</option>
                                            <option value="6학년">6학년</option>
                                        </select></div>
                                    <div style="flex:1;"><label style="font-size:0.8rem;">평가 대상</label><select
                                            id="autoTargetSelect" style="margin-bottom:0;">
                                            <option value="individual">개인 평가</option>
                                            <option value="group">모둠 평가</option>
                                        </select></div>
                                </div>
                                <button type="button" onclick="generateCriteriaAI(this)"
                                    style="background:linear-gradient(135deg, #9575CD 0%, #7E57C2 100%); width:100%;">🤖
                                    2단계: AI로 기준 자동 생성하기</button>
                            </div>
                            <div id="autoResultInputs">
                                <div style="margin-bottom:12px;"><label
                                        style="font-size:0.85rem; color:var(--color-blue);">① 지식・이해</label><input
                                        type="text" id="autoRate1" placeholder="AI 결과 1" style="margin-bottom:5px;"
                                        readonly disabled><input type="text" id="autoRate2" placeholder="AI 결과 2"
                                        style="margin-bottom:0;" readonly disabled></div>
                                <div style="margin-bottom:12px;"><label
                                        style="font-size:0.85rem; color:var(--color-teal);">② 과정・기능</label><input
                                        type="text" id="autoRate3" placeholder="AI 결과 3" style="margin-bottom:5px;"
                                        readonly disabled><input type="text" id="autoRate4" placeholder="AI 결과 4"
                                        style="margin-bottom:0;" readonly disabled></div>
                                <div style="margin-bottom:12px;"><label
                                        style="font-size:0.85rem; color:var(--color-eval);">③ 가치・태도</label><input
                                        type="text" id="autoRate5" placeholder="AI 결과 5" style="margin-bottom:5px;"
                                        readonly disabled><input type="text" id="autoRate6" placeholder="AI 결과 6"
                                        style="margin-bottom:0;" readonly disabled></div>
                            </div>
                        </div>
                        <div id="manualCriteriaArea" class="hidden">
                            <div style="margin-bottom:15px;">
                                <div
                                    style="font-weight:700; color:var(--color-blue); font-size:0.9rem; margin-bottom:8px;">
                                    ① 지식・이해</div><input type="text" id="settingRate1" placeholder="기준 1"
                                    style="margin-bottom:8px;"><input type="text" id="settingRate2" placeholder="기준 2"
                                    style="margin-bottom:0;">
                            </div>
                            <div style="margin-bottom:15px;">
                                <div
                                    style="font-weight:700; color:var(--color-teal); font-size:0.9rem; margin-bottom:8px;">
                                    ② 과정・기능</div><input type="text" id="settingRate3" placeholder="기준 1"
                                    style="margin-bottom:8px;"><input type="text" id="settingRate4" placeholder="기준 2"
                                    style="margin-bottom:0;">
                            </div>
                            <div style="margin-bottom:15px;">
                                <div
                                    style="font-weight:700; color:var(--color-eval); font-size:0.9rem; margin-bottom:8px;">
                                    ③ 가치・태도</div><input type="text" id="settingRate5" placeholder="기준 1"
                                    style="margin-bottom:8px;"><input type="text" id="settingRate6" placeholder="기준 2"
                                    style="margin-bottom:0;">
                            </div>
                        </div>
                        <button onclick="saveDailyCriteria(this)"
                            style="background:var(--color-teal); margin-top:20px;">💾 3단계: 평가기준 저장하기</button>
                    </div>
                    <div class="accent-box box-violet">
                        <span class="box-label">🏫 우리 반 구성 설정</span>
                        <div style="display:flex; gap:15px; margin-bottom:15px;">
                            <div style="flex:1;"><label>👤 학생 수</label><input type="number" id="settingStudentCount"
                                    min="1" max="50" placeholder="30"></div>
                            <div style="flex:1;"><label>👥 모둠 수</label><input type="number" id="settingGroupCount"
                                    min="1" max="20" placeholder="6"></div>
                        </div>
                        <button onclick="saveClassSettingsUI(this)" style="background:var(--color-teacher);">💾 반 구성
                            저장하기</button>
                        <p style="font-size:0.8rem; color:var(--text-sub); margin-top:10px; text-align:center;">※ 저장하면
                            인증코드가 자동으로 해당 인원 수에 맞게 조정됩니다.</p>
                    </div>
                    <div class="accent-box box-blue">
                        <span class="box-label">👥 사용자 관리</span>
                        <h5 style="margin-top:0;">👤 학생</h5>
                        <div id="studentManageGrid" class="student-manage-grid"></div>
                        <button onclick="saveStudentAuth(this)"
                            style="margin-top:10px; margin-bottom:20px; background:var(--color-blue);">학생 비밀번호
                            저장</button>
                        <hr style="border:0; border-top:1px dashed var(--border); margin:15px 0;">
                        <h5>👥 모둠</h5>
                        <div id="groupManageGrid" class="student-manage-grid"
                            style="grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));"></div>
                        <button onclick="saveGroupAuth(this)" style="margin-top:10px; background:var(--color-blue);">모둠
                            비밀번호 저장</button>
                    </div>
                    <div class="accent-box box-slate">
                        <span class="box-label">🔐 교사 비밀번호 변경</span>
                        <input type="text" id="newTeacherPw" placeholder="새 비밀번호 입력">
                        <button onclick="changeTeacherPw(this)" style="background:var(--color-setting);">비밀번호
                            변경</button>
                    </div>
                    <div class="accent-box box-red">
                        <span class="box-label" style="color:var(--color-danger);">⚠️ 데이터 초기화</span>
                        <p style="color:var(--color-danger); font-size:0.9rem; margin-bottom:15px;"><strong>주의:</strong>
                            모든 평가 데이터가 삭제됩니다.<br>(기준과 비밀번호는 유지됨)</p>
                        <button id="resetBtn" onclick="resetAllReviewData(this)">평가 데이터 전체 초기화</button>
                    </div>
                    <div id="settingMsg" class="message"></div>
                </div>
            </div>
        </div>
    </div>
    <div id="customModal" class="modal-overlay hidden">
        <div class="modal-box">
            <span id="modalIcon" class="modal-icon">🤔</span>
            <div id="modalTitle" class="modal-title">알림</div>
            <div id="modalMessage" class="modal-text"></div>
            <input type="text" id="modalInput" class="hidden"
                style="width:100%; box-sizing:border-box; padding:12px; margin-bottom:20px; border:2px solid var(--border); border-radius:10px; font-size:1rem; outline:none;">
            <div class="modal-buttons">
                <button class="modal-btn cancel" id="modalCancelBtn">취소</button>
                <button class="modal-btn confirm" id="modalConfirmBtn">확인</button>
            </div>
        </div>
    </div>
    <button class="theme-toggle" onclick="toggleTheme()" aria-label="다크모드 전환"><span id="themeIcon">🌙</span></button>
    <script src="app.js"></script>
</body>

</html>